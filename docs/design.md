# 功能需求

**粗体的**优先搞

正体的不着急

*斜体的*先放放

<span style="color:red;">红色的</span>做不出来



- 用户
  - **注册**
  - **登录**
  - **登出**
  - **搜索商户**
    - **按距离排序**
    - **按人均消费排序**
    - **按销量排序**
    - <span style="color:red;">配送范围限制</span>
    - *标签筛选*
  - **搜索菜品**
    - **按价格排序**
    - **按销量排序**
  - **下达订单**
  - **查看订单**
  - <span style="color:red;">取消订单</span>
- 商户
  - 创建
  - 修改商户信息
  - 添加、修改、删除菜品
  - 设置是否营业
  - 查看订单
  - 设置订单送达

# 模块设计

分若干模块（app）：

| app名称 | 说明     | 功能                                                         |
| ------- | -------- | ------------------------------------------------------------ |
| user    | 用户管理 | 用户注册、登录、登出                                         |
| view    | 界面展现 | 展现给用户的界面，**不涉及任何业务逻辑**，仅包含简单的数据库查询 |
| shop    | 商户管理 | 创建商户、修改信息、设置是否营业                             |
| dish    | 菜品管理 | 添加、修改、删除菜品                                         |
| order   | 订单管理 | 下达订单，查看订单（买家和商户），设置订单送达时间（商户）   |
| search  | 搜索处理 | 处理搜索（商户，菜品）请求                                   |

除了view模块之外，其它模块均不涉及前端，所有请求返回JSON，格式为：

```jsmin
{
    "code": 0,   // 错误码，0表示无错误
    "msg": "",   // 错误信息
    "page": 100, // 分页数量，仅在某些请求中出现
    "data": {}   // 返回数据，如果出错无此项
}
```

错误码：

| 错误码 | 错误信息       | 描述                                                         |
| ------ | -------------- | ------------------------------------------------------------ |
| 101    | 参数不正确     | 缺失了某些必要的参数，或者某些参数的类型不正确               |
| 102    | 实体不存在     | 涉及到的ID在数据库中不存在                                   |
| 103    | 没有权限       | 密码错误，用户尚未登录，或者用户无权进行操作                 |
| 104    | 名字重复       | 添加/注册的实体名字与已有的重复                              |
| 105    | 参数不合法     | 参数语法正确，但是语义不正确（例如购买不属于同一商户的菜品等） |
| 106    | 目标不提供服务 | 餐厅尚未营业，或者菜品缺货                                   |

## user

### 用户注册

请求地址：/user/register

请求方法：POST

请求参数：

| 请求参数 | 类型   | 是否必须 | 说明         | 备注     |
| -------- | ------ | -------- | ------------ | -------- |
| username | STRING | 是       | 用户名       |          |
| password | STRING | 是       | 用户密码     | 明文传输 |
| addr     | STRING | 否       | 默认地址     |          |
| loc_lng  | FLOAT  | 否       | 默认位置经度 |          |
| loc_lat  | FLOAT  | 否       | 默认位置纬度 |          |
| phone    | STRING | 是       | 电话号码     |          |

返回数据：无

- 如果用户名和一个已经存在的用户冲突，则返回错误104
- 如果注册成功，那么用户自动登录

### 用户登录

请求地址：/user/login

请求方法：POST

请求参数：

| 请求参数 | 类型   | 是否必须 | 说明   | 备注     |
| -------- | ------ | -------- | ------ | -------- |
| username | STRING | 是       | 用户名 |          |
| password | STRING | 是       | 密码   | 明文传输 |

返回数据：无

- 如果登录失败，一律返回错误103，**错误信息不区分用户名不存在和密码错误**

### 用户登出

请求地址：/user/logout

请求方法：POST

请求参数：无

返回数据：无

- 该接口**无需CSRF验证**

## view

TODO 我搞不来，前端搞

## shop

### 创建商户

请求地址：/shop/create

请求方法：POST

请求参数：

| 请求参数  | 类型   | 是否必须 | 说明         | 备注     |
| --------- | ------ | -------- | ------------ | -------- |
| name      | STRING | 是       | 商户姓名     |          |
| image     | IMAGE  | 是       | 商户图片     | 是个文件 |
| desc      | STRING | 是       | 商户说明     |          |
| addr      | STRING | 是       | 商户地址     |          |
| loc_lng   | FLOAT  | 是       | 商户位置经度 |          |
| loc_lat   | FLOAT  | 是       | 商户位置纬度 |          |
| avg_price | FLOAT  | 是       | 商户人均消费 |          |
| phone     | STRING | 是       | 商户电话号码 |          |

返回数据：

| 字段    | 类型    | 说明           | 备注 |
| ------- | ------- | -------------- | ---- |
| shop_id | INTEGER | 新创建的商户ID |      |

- 需要用户已经登录，新创建的商户将在当前用户名下
- 商户销售量初始为0
- 新增商户默认正在营业
- **商户可以重名**

### 浏览商户

这个接口与搜索商户的不同在于，浏览商户返回所有在自己名下的商户信息。

请求地址：/shop/mine

请求方法：GET

请求参数：无

返回数据：与搜索商户接口返回的数据格式相同（没有dist字段）。

- 用户必须登录

### 修改信息（与设置是否营业）

请求地址：/shop/edit

请求方法：POST

请求参数：

| 请求参数  | 类型    | 是否必须 | 说明         | 备注     |
| --------- | ------- | -------- | ------------ | -------- |
| shop_id   | INTEGER | 是       | 商户ID       |          |
| name      | STRING  | 否       | 商户名称     |          |
| image     | IMAGE   | 否       | 商户图片     | 是个文件 |
| desc      | STRING  | 否       | 商户说明     |          |
| addr      | STRING  | 否       | 商户地址     |          |
| loc_lng   | FLOAT   | 否       | 商户位置经度 |          |
| loc_lat   | FLOAT   | 否       | 商户位置纬度 |          |
| avg_price | FLOAT   | 否       | 商户人均消费 |          |
| phone     | STRING  | 否       | 商户电话号码 |          |
| serving   | BOOLEAN | 否       | 是否营业     |          |

返回数据：无

- 用户必须已登录，且给出的商户必须在当前用户名下

## dish

### 新增菜品

请求地址：/dish/create

请求方法：POST

请求参数：

| 请求参数 | 类型    | 是否必须 | 说明     | 备注     |
| -------- | ------- | -------- | -------- | -------- |
| shop_id  | INTEGER | 是       | 商户ID   |          |
| name     | STRING  | 是       | 菜品名称 |          |
| image    | IMAGE   | 是       | 菜品图片 | 是个文件 |
| desc     | STRING  | 是       | 菜品说明 |          |
| price    | FLOAT   | 是       | 菜品单价 |          |

返回数据：

| 字段    | 类型    | 说明   | 备注 |
| ------- | ------- | ------ | ---- |
| dish_id | INTEGER | 菜品ID |      |

- 用户必须已登录，且给出的商户必须在当前用户名下
- 新增菜品默认有货
- 菜品销量初始为0

### 修改信息（与设置是否有货）

请求地址：/dish/edit

请求方法：POST

请求参数：

| 请求参数 | 类型    | 是否必须 | 说明     | 备注     |
| -------- | ------- | -------- | -------- | -------- |
| dish_id  | INTEGER | 是       | 菜品ID   |          |
| name     | STRING  | 否       | 菜品名称 |          |
| image    | IMAGE   | 否       | 菜品图片 | 是个文件 |
| desc     | STRING  | 否       | 菜品说明 |          |
| price    | FLOAT   | 否       | 菜品单价 |          |
| serving  | BOOLEAN | 否       | 是否有货 |          |

返回数据：无

- 用户必须已登录，且菜品位于的商户必须在当前用户名下

### order

### 下达订单

请求地址：/order/new

请求方法：POST

请求参数：

| 请求参数 | 类型    | 是否必须 | 说明     | 备注            |
| -------- | ------- | -------- | -------- | --------------- |
| shop_id  | INTEGER | 是       | 商户ID   |                 |
| dish_id  | ARRAY   | 是       | 菜品ID   | 整型数组        |
| amount   | ARRAY   | 是       | 数量     | 整型数组，大于0 |
| addr     | STRING  | 是       | 地址     |                 |
| loc_lng  | FLOAT   | 是       | 位置经度 |                 |
| loc_lat  | FLOAT   | 是       | 位置纬度 |                 |
| remarks  | STRING  | 是       | 订单备注 |                 |

返回数据：

| 字段     | 类型    | 说明   | 备注 |
| -------- | ------- | ------ | ---- |
| order_id | INTEGER | 订单ID |      |

- 用户必须已登录，否则返回错误103
- 所有菜品均有货，否则返回错误106，并在错误信息中说明哪个菜品没有货
- 商户必须在营业，否则返回错误106
- 所有菜品均与提供的商户有关，否则返回错误105，并在错误信息中说明哪个菜品不属于这个商户
- 给出的商户**不能**在当前用户名下（不能买自己店），否则返回错误105
- 请求成功后，向数据库中添加订单相关信息和订单-菜品相关信息，订单的下单时间自动填写为服务器时间
- 请求成功后，对应商户销量+1，对应菜品销量增加其购买数量。

### 查看订单

请求地址：/order/info

请求方法：GET

请求参数：

| 请求参数   | 类型    | 是否必须 | 说明                 | 备注                                         |
| ---------- | ------- | -------- | -------------------- | -------------------------------------------- |
| order_id   | INTEGER | 否       | 订单ID               | 不提供则返回所有和该用户（或商户）相关的订单 |
| shop_id    | INTEGER | 否       | 商户ID               | 不提供则为用户视角，提供则为商家视角         |
| page       | INTEGER | 是       | 页码                 | 从1开始                                      |
| limit      | INTEGER | 是       | 每页数量限制         |                                              |
| unfinished | BOOLEAN | 否       | 是否只返回未完成订单 | 默认为`False`                                |

返回数据为一个数组，数组中的每个对象包含以下字段：

| 字段        | 类型    | 说明             | 备注                     |
| ----------- | ------- | ---------------- | ------------------------ |
| user_id     | INTEGER | 下单用户ID       |                          |
| username    | STRING  | 下单用户名       |                          |
| phone       | STRING  | 下单用户电话号码 |                          |
| shop_id     | INTEGER | 处理商户ID       |                          |
| shop_name   | STRING  | 处理商户名称     |                          |
| dishes      | ARRAY   | 所购菜品         | 对象数组                 |
| addr        | STRING  | 送达地址         |                          |
| loc_lng     | FLOAT   | 送达位置经度     |                          |
| loc_lat     | FLOAT   | 送达位置纬度     |                          |
| remarks     | STRING  | 订单备注         |                          |
| tm_ordered  | LONG    | 下单时间         |                          |
| tm_finished | LONG    | 送达时间         | 可能为`null`，表示未送达 |

其中dishes字段是一个数组，数组中每个对象包含以下字段：

| 字段    | 类型    | 说明     | 备注 |
| ------- | ------- | -------- | ---- |
| dish_id | INTEGER | 菜品ID   |      |
| name    | STRING  | 菜品名称 |      |
| amount  | INTEGER | 购买数量 |      |

- 如果提供order_id，则该订单必须与当前用户（或商户）相关，否则返回错误103
- 如果提供shop_id，则该商户必须与提供的用户相关，否则返回103

### 设置订单送达
~~~~~~~~~~~~~~~~
请求地址：/order/finish

请求方法：POST

请求参数：

| 请求参数 | 类型    | 是否必须 | 说明     | 备注               |
| -------- | ------- | ------ | ---- | ---- |
| order_id | INTEGER | 是 | 订单ID ||

返回数据：无

- 该订单必须与当前用户相关，否则返回错误103
- 该订单必须尚未送达，否则返回错误105

- 请求成功后，修改数据库中订单信息，将送达时间填写为服务器时间

## search

## 搜索商户

请求地址：/search/shop

请求方法：GET

请求参数：

| 请求参数 | 类型    | 是否必须 | 说明                   | 备注                      |
| -------- | ------- | -------- | ---------------------- | ------------------------- |
| name     | STRING  | 是       | 商户名称               | 搜索相似的名字            |
| order    | STRING  | 是       | 排序方式               |                           |
| loc_lng  | FLOAT   | 否       | 查询位置经度           | 当且仅当order为dist是提供 |
| loc_lat  | FLOAT   | 否       | 查询位置纬度           | 当且仅当order为dist是提供 |
| tags     | STRING  | 否       | 筛选的标签             | 数组                      |
| page     | INTEGER | 是       | 页码                   | 从1开始                   |
| limit    | INTEGER | 是       | 每页数量限制           |                           |
| serving  | BOOLEAN | 否       | 是否只返回营业中的商户 | 默认为`False`             |

order的可能取值：

- `dist`：按距离从近到远排序
- `avg_price`：按人均消费从低到高排序
- `sales`：按销量从高到低排序

返回数据是一个数组，数组中每个对象都包含以下字段：

| 字段      | 类型    | 说明             | 备注                               |
| --------- | ------- | ---------------- | ---------------------------------- |
| shop_id   | INTEGER | 商户ID           |                                    |
| name      | STRING  | 商户名称         |                                    |
| image     | STRING  | 商户图片         | static目录下的文件名，包含扩展名 |
| desc      | STRING  | 商户描述         |                                    |
| addr      | STRING  | 商户地址         |                                    |
| loc_lng   | FLOAT   | 商户位置经度     |                                    |
| loc_lat   | FLOAT   | 商户位置纬度     |                                    |
| dist      | FLOAT   | 距查询位置距离   | 单位：米  x                         |
| avg_price | FLOAT   | 商户人均消费     | 单位：元（**不是分**）             |
| sales     | INTEGER | 商户销量         |                                    |
| phone     | STRING  | 商户电话号码     |                                    |
| serving   | BOOLEAN | 商户是否正在营业 |                                    |

该请求返回的数据已经有序，并且会返回分页数量。

## 搜索菜品

请求地址：/search/dish

请求方法：GET

请求参数：

| 请求参数 | 类型    | 是否必须 | 说明                 | 备注                   |
| -------- | ------- | -------- | -------------------- | ---------------------- |
| shop_id  | INTEGER | 是       | 商户ID               | 仅搜索该商户提供的菜品 |
| name     | STRING  | 是       | 菜品名字             | 搜索相似的名字         |
| order    | STRING  | 是       | 排序方式             |                        |
| page     | INTEGER | 是       | 页码                 | 从1开始                |
| limit    | INTEGER | 是       | 每页数量限制         |                        |
| serving  | BOOLEAN | 否       | 是否只返回有货的菜品 | 默认为`False`          |

order的可能取值：

- `price`：按单价从低到高排序
- `sales`：按销量从高到低排序

返回数据是一个数组，数组中每个对象都包含以下字段：

| 字段    | 类型    | 说明         | 备注                             |
| ------- | ------- | ------------ | -------------------------------- |
| dish_id | INTEGER | 菜品ID       |                                  |
| name    | STRING  | 菜品名称     |                                  |
| image   | STRING  | 菜品图片     | static目录下的文件名，包括扩展名 |
| desc    | STRING  | 菜品描述     |                                  |
| price   | FLOAT   | 菜品单价     | 单位：元（**不是分**）           |
| sales   | INTEGER | 菜品销量     |                                  |
| serving | BOOLEAN | 菜品是否有货 |                                  |

该请求返回的数据已经有序，并且会返回分页数量。
